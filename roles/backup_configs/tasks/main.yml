---
# Tasks for backup_configs role

- name: Ensure backup directories exist
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0755'
  loop:
    - "{{ backup_base_dir }}"
    - "{{ backup_base_dir }}/daily"
    - "{{ backup_base_dir }}/weekly"
    - "{{ backup_base_dir }}/monthly"

- name: Deploy configuration backup script
  template:
    src: backup-configs.sh.j2
    dest: /usr/local/bin/backup-configs.sh
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0750'
  become: yes

- name: Create cron job for daily configuration backup
  cron:
    name: "Daily configuration backup"
    minute: "0"
    hour: "3"
    job: "/usr/local/bin/backup-configs.sh"
    user: "{{ backup_user }}"
    state: present

- name: Display backup information
  debug:
    msg:
      - "Configuration backup configured successfully!"
      - "Backup location: {{ backup_base_dir }}"
      - "Daily backups at: 3:00 AM"
      - "Backs up: Nginx configs, App code, PostgreSQL configs, Ansible infrastructure"
