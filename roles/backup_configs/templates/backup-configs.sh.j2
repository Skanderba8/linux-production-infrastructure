#!/bin/bash
#
# Configuration Backup Script
# Managed by Ansible - Do not edit manually
#
# NOTE: This script should be run as {{ backup_user }}, not root

set -e  # Exit on error

# Configuration
BACKUP_DIR="{{ backup_base_dir }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DATE=$(date +%Y%m%d)
DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
DAY_OF_MONTH=$(date +%d)

# Backup directories
DAILY_DIR="${BACKUP_DIR}/daily"
WEEKLY_DIR="${BACKUP_DIR}/weekly"
MONTHLY_DIR="${BACKUP_DIR}/monthly"
TEMP_DIR="/tmp/config-backup-${TIMESTAMP}"
LOG_FILE="/var/backups/logs/backup-configs-${DATE}.log"

# Ansible inventory
ANSIBLE_DIR="/home/{{ backup_user }}/infrastructure"

# Create directories (with sudo for system paths)
sudo mkdir -p "${DAILY_DIR}" "${WEEKLY_DIR}" "${MONTHLY_DIR}"
sudo chown {{ backup_user }}:{{ backup_user }} "${DAILY_DIR}" "${WEEKLY_DIR}" "${MONTHLY_DIR}"
mkdir -p "${TEMP_DIR}"
sudo mkdir -p /var/backups/logs
sudo chown {{ backup_user }}:{{ backup_user }} /var/backups/logs

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

log "===== Starting Configuration Backup ====="

# Function to backup from remote server using Ansible
backup_remote() {
    local SERVER=$1
    local SOURCE=$2
    local DEST_NAME=$3
    
    log "Backing up ${DEST_NAME} from ${SERVER}..."
    
    # Use Ansible to fetch and archive the files
    if cd "${ANSIBLE_DIR}" && ansible ${SERVER} -m shell -a "sudo tar czf /tmp/${DEST_NAME}.tar.gz ${SOURCE}" -b >> "${LOG_FILE}" 2>&1; then
        if cd "${ANSIBLE_DIR}" && ansible ${SERVER} -m fetch -a "src=/tmp/${DEST_NAME}.tar.gz dest=${TEMP_DIR}/${DEST_NAME}.tar.gz flat=yes" >> "${LOG_FILE}" 2>&1; then
            # Cleanup remote temp file
            cd "${ANSIBLE_DIR}" && ansible ${SERVER} -m file -a "path=/tmp/${DEST_NAME}.tar.gz state=absent" -b >> "${LOG_FILE}" 2>&1
            
            if [ -f "${TEMP_DIR}/${DEST_NAME}.tar.gz" ]; then
                SIZE=$(du -h "${TEMP_DIR}/${DEST_NAME}.tar.gz" | cut -f1)
                log "✓ ${DEST_NAME}: ${SIZE}"
                return 0
            else
                log "✗ ERROR: Backup file not found for ${DEST_NAME}"
                return 1
            fi
        else
            log "✗ ERROR: Failed to fetch ${DEST_NAME} from ${SERVER}"
            return 1
        fi
    else
        log "✗ ERROR: Failed to create archive for ${DEST_NAME} on ${SERVER}"
        return 1
    fi
}

# Function to backup local files
backup_local() {
    local SOURCE=$1
    local DEST_NAME=$2
    
    log "Backing up ${DEST_NAME} (local)..."
    
    if [ -e "${SOURCE}" ]; then
        if sudo tar czf "${TEMP_DIR}/${DEST_NAME}.tar.gz" -C / "${SOURCE#/}" 2>> "${LOG_FILE}"; then
            SIZE=$(du -h "${TEMP_DIR}/${DEST_NAME}.tar.gz" | cut -f1)
            log "✓ ${DEST_NAME}: ${SIZE}"
            return 0
        else
            log "✗ ERROR: Failed to backup ${DEST_NAME}"
            return 1
        fi
    else
        log "⚠ WARNING: ${SOURCE} does not exist, skipping"
        return 0
    fi
}

# Backup from web-server
backup_remote "web-server" "/etc/nginx" "web-nginx-config"

# Backup from app-server
backup_remote "app-server" "/opt/myapp" "app-myapp-code"

# Backup from db-server
backup_remote "db-server" "/etc/postgresql" "db-postgresql-config"

# Backup local control-node configs
backup_local "/home/{{ backup_user }}/infrastructure" "control-ansible-infra"
backup_local "/etc/prometheus" "control-prometheus-config"
backup_local "/etc/grafana" "control-grafana-config"

# Create final archive
BACKUP_FILE="${DAILY_DIR}/configs_${TIMESTAMP}.tar.gz"
log "Creating final backup archive..."

cd "${TEMP_DIR}"
if tar czf "${BACKUP_FILE}" *.tar.gz 2>> "${LOG_FILE}"; then
    TOTAL_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    log "✓ Final backup created: ${BACKUP_FILE}"
    log "✓ Total size: ${TOTAL_SIZE}"
    
    # Count individual archives
    ARCHIVE_COUNT=$(ls -1 *.tar.gz 2>/dev/null | wc -l)
    log "✓ Individual archives included: ${ARCHIVE_COUNT}"
else
    log "✗ ERROR: Failed to create final backup archive"
    rm -rf "${TEMP_DIR}"
    exit 1
fi

# Cleanup temp directory
rm -rf "${TEMP_DIR}"

# Verify backup integrity
log "Verifying backup integrity..."
if tar tzf "${BACKUP_FILE}" >/dev/null 2>&1; then
    FILE_COUNT=$(tar tzf "${BACKUP_FILE}" | wc -l)
    log "✓ Backup integrity verified (${FILE_COUNT} files)"
else
    log "✗ ERROR: Backup file is corrupted!"
    exit 1
fi

# Weekly backup (Sunday)
if [ "${DAY_OF_WEEK}" -eq 7 ]; then
    WEEKLY_FILE="${WEEKLY_DIR}/configs_weekly_${DATE}.tar.gz"
    cp "${BACKUP_FILE}" "${WEEKLY_FILE}"
    log "✓ Weekly backup created: ${WEEKLY_FILE}"
fi

# Monthly backup (1st-7th of month AND Sunday)
if [ "${DAY_OF_MONTH}" -le 7 ] && [ "${DAY_OF_WEEK}" -eq 7 ]; then
    MONTHLY_FILE="${MONTHLY_DIR}/configs_monthly_${DATE}.tar.gz"
    cp "${BACKUP_FILE}" "${MONTHLY_FILE}"
    log "✓ Monthly backup created: ${MONTHLY_FILE}"
fi

# Cleanup old backups
log "Cleaning up old backups..."

# Daily: Keep last {{ daily_retention }} days
find "${DAILY_DIR}" -name "*.tar.gz" -type f -mtime +{{ daily_retention }} -delete 2>/dev/null || true
DAILY_COUNT=$(find "${DAILY_DIR}" -name "*.tar.gz" -type f 2>/dev/null | wc -l)
log "✓ Daily backups retained: ${DAILY_COUNT} files"

# Weekly: Keep last {{ weekly_retention }} days
find "${WEEKLY_DIR}" -name "*.tar.gz" -type f -mtime +{{ weekly_retention }} -delete 2>/dev/null || true
WEEKLY_COUNT=$(find "${WEEKLY_DIR}" -name "*.tar.gz" -type f 2>/dev/null | wc -l)
log "✓ Weekly backups retained: ${WEEKLY_COUNT} files"

# Monthly: Keep last {{ monthly_retention }} days
find "${MONTHLY_DIR}" -name "*.tar.gz" -type f -mtime +{{ monthly_retention }} -delete 2>/dev/null || true
MONTHLY_COUNT=$(find "${MONTHLY_DIR}" -name "*.tar.gz" -type f 2>/dev/null | wc -l)
log "✓ Monthly backups retained: ${MONTHLY_COUNT} files"

log "===== Configuration Backup Complete ====="
log ""

exit 0
